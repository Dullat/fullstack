
Youâ€™ve learned:

- Readable (data comes in)
    
- Writable (data goes out)
    
- Backpressure (flow control)
    
- pipe / pipeline (connecting streams)
    

Now:

# ðŸ§  What Is a Duplex Stream?

A **Duplex** stream is:

> A stream that is BOTH Readable and Writable.

It can:

```text
Receive data  â† Writable side
Send data     â†’ Readable side
```

Two independent channels inside one object.

---

# ðŸ§± Real-World Duplex Examples

Duplex streams exist everywhere in Node:

- `net.Socket` (TCP connection)
    
- HTTP request object
    
- HTTP response object (kind of writable only outward)
    
- WebSockets
    
- TLS sockets
    

Example:

When you open a TCP connection:

```text
Client â†” Server
```

You:

- Write data to socket
    
- Read data from socket
    

Thatâ€™s Duplex.

---

# ðŸ§  Important Concept

Very important:

> The readable side and writable side are independent.

They have:

```text
Readable:
  _read()
  readableHighWaterMark
  _readableState

Writable:
  _write()
  writableHighWaterMark
  _writableState
```

Two buffers.  
Two flow systems.  
Two highWaterMarks.

---

# ðŸ§  Basic Example: Create a Duplex

```js
const { Duplex } = require("stream");

class MyDuplex extends Duplex {
  constructor(options) {
    super(options);
  }

  _write(chunk, encoding, callback) {
    console.log("Writable side received:", chunk.toString());
    callback();
  }

  _read(size) {
    console.log("Readable side requested data");

    this.push("Hello from readable side\n");
    this.push(null); // end readable
  }
}

const d = new MyDuplex();

d.on("data", (chunk) => {
  console.log("Reading:", chunk.toString());
});

d.write("Sending into writable\n");
d.end();
```

Output:

```text
Writable side received: Sending into writable
Readable side requested data
Reading: Hello from readable side
```

---

# ðŸ§  How Duplex Works Internally

Internally it does:

```js
class Duplex extends Readable
```

But it mixes in Writable prototype methods.

So internally:

```text
Duplex = Readable + Writable combined
```

Node maintains:

```js
this._readableState
this._writableState
```

Two separate state machines.

---

# ðŸ”¥ Important: Backpressure In Duplex

Backpressure applies separately:

Writable side:

- write() returns false
    
- emits drain
    

Readable side:

- respects push() return value
    

Yes â€” `push()` also returns boolean.

If:

```js
this.push(chunk)
```

Returns `false`, it means:

> Consumer is slow â€” stop pushing.

This is advanced-level knowledge.

---

# ðŸ§  Real Example â€” Echo Stream

Letâ€™s build a duplex that echoes what it receives.

```js
const { Duplex } = require("stream");

class EchoDuplex extends Duplex {
  constructor(options) {
    super(options);
  }

  _write(chunk, encoding, callback) {
    // send received data back out
    this.push(chunk);
    callback();
  }

  _read(size) {
    // nothing to do here
  }
}

const echo = new EchoDuplex();

echo.on("data", (data) => {
  console.log("Echoed:", data.toString());
});

echo.write("Hello\n");
echo.write("World\n");
```

Flow:

```text
write() â†’ _write() â†’ push() â†’ readable emits data
```

Thatâ€™s a real duplex behavior.

---

# ðŸ§  Real System Example â€” TCP Socket

TCP socket is Duplex.

Example:

```js
const net = require("net");

const server = net.createServer((socket) => {
  socket.on("data", (data) => {
    console.log("Client says:", data.toString());
    socket.write("Server got it\n");
  });
});

server.listen(4000);
```

Here:

- `socket.write()` â†’ writable side
    
- `socket.on("data")` â†’ readable side
    

Same object.

---

# ðŸ§  Advanced Concept â€” Half-Open State

Duplex streams can be:

```text
Readable closed, Writable open
Writable closed, Readable open
Both closed
```

Example:

TCP FIN packet closes writable side but readable side may still receive data.

Node supports this via:

```js
allowHalfOpen: true
```

Default is true for net.Socket.

---

# ðŸ§  Duplex vs Transform

Very important distinction:

|Duplex|Transform|
|---|---|
|Read/write independent|Output depends on input|
|You control both sides separately|Writable feeds Readable|
|Two separate channels|One channel transforms|

Example:

Duplex:

- Chat socket
    

Transform:

- gzip compression
    

---

# ðŸ§  Deep Internal Lifecycle

Writable side:

```text
write()
â†“
buffer
â†“
_write()
â†“
callback()
â†“
drain if needed
```

Readable side:

```text
consumer asks
â†“
_read()
â†“
push()
â†“
data event
```

These two systems live together but are independent.

---

# ðŸ§  Interview Questions (Duplex)

---

### 1ï¸âƒ£ What is a Duplex stream?

> A stream that implements both Readable and Writable interfaces.

---

### 2ï¸âƒ£ Are readable and writable sides linked?

> No. They have separate internal buffers and states.

---

### 3ï¸âƒ£ Give real-world example.

> TCP socket.

---

### 4ï¸âƒ£ What is allowHalfOpen?

> Allows one side of duplex to remain open when the other ends.

---

### 5ï¸âƒ£ What happens if push() returns false?

> Stop pushing until _read() is called again.

---

### 6ï¸âƒ£ Difference between Duplex and Transform?

Strong answer:

> Duplex allows independent readable and writable sides. Transform is a special Duplex where output is generated from input.

---

# ðŸ§  Senior-Level Understanding

If you truly understand Duplex, you understand:

- Full-duplex network communication
    
- Bidirectional streaming
    
- Protocol implementations
    
- WebSocket internals
    
- Database drivers