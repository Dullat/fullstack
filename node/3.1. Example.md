# ðŸ”¥ COMPLEX EXAMPLE: Poll Phase + Fast Cleanup

a **real-world scenario** where Poll phase and fast cleanup dance together.

---

## ðŸ“ THE CODE

```js
console.log('1: Start');

// Schedule a file read
fs.readFile('data.txt', () => {
  console.log('2: File read complete');
  
  // Inside file callback, schedule more stuff
  process.nextTick(() => console.log('3: nextTick inside file'));
  Promise.resolve().then(() => console.log('4: Promise inside file'));
  
  // Another file read!
  fs.readFile('data2.txt', () => {
    console.log('5: Second file read complete');
    
    process.nextTick(() => console.log('6: nextTick inside second file'));
    Promise.resolve().then(() => console.log('7: Promise inside second file'));
  });
  
  console.log('8: Sync code after scheduling');
});

// Schedule another file read (parallel to first)
fs.readFile('data3.txt', () => {
  console.log('9: Third file read complete');
  
  process.nextTick(() => console.log('10: nextTick inside third file'));
  Promise.resolve().then(() => console.log('11: Promise inside third file'));
});

console.log('12: End of main script');
```

---

## ðŸŽ¬ EXECUTION TIMELINE (Step-by-step)

### **STEP 1: Sync code runs**

```
Output: 
1: Start
12: End of main script
```

âœ… All sync code done  
âœ… No ticks or promises scheduled yet  
âœ… Node enters event loop

---

### **STEP 2: Poll phase (first visit)**

Node waits for I/O. Let's say `data.txt` and `data3.txt` finish at the same time.

**Poll phase executes:** First file callback

```js
console.log('2: File read complete');
process.nextTick(() => console.log('3: nextTick inside file'));
Promise.resolve().then(() => console.log('4: Promise inside file'));
fs.readFile('data2.txt', ...); // scheduled
console.log('8: Sync code after scheduling');
```

```
Output:
2: File read complete
8: Sync code after scheduling
```

âš ï¸ **STOP!** File callback finished. Now Node does **fast cleanup**.

---

### **STEP 3: Fast cleanup #1**

```
Output:
3: nextTick inside file
4: Promise inside file
```

âœ… All ticks run  
âœ… All promises run  
âœ… Back to Poll phase

---

### **STEP 4: Poll phase (still same iteration)**

Still in Poll phase. Next callback ready: `data3.txt`

```js
console.log('9: Third file read complete');
process.nextTick(() => console.log('10: nextTick inside third file'));
Promise.resolve().then(() => console.log('11: Promise inside third file'));
```

```
Output:
9: Third file read complete
```

âš ï¸ **STOP!** Callback finished. **Fast cleanup again!**

---

### **STEP 5: Fast cleanup #2**

```
Output:
10: nextTick inside third file
11: Promise inside third file
```

âœ… All ticks run  
âœ… All promises run  
âœ… Back to Poll phase

---

### **STEP 6: Poll phase waits**

`data2.txt` is still reading from disk. Poll phase **blocks/waits**.

Eventually `data2.txt` finishes...

---

### **STEP 7: Poll phase (next iteration)**

```js
console.log('5: Second file read complete');
process.nextTick(() => console.log('6: nextTick inside second file'));
Promise.resolve().then(() => console.log('7: Promise inside second file'));
```

```
Output:
5: Second file read complete
```

âš ï¸ **STOP!** Fast cleanup time!

---

### **STEP 8: Fast cleanup #3**

```
Output:
6: nextTick inside second file
7: Promise inside second file
```

âœ… Done!

---

## ðŸŽ¯ FINAL OUTPUT (in order)

```
1: Start
12: End of main script
2: File read complete
8: Sync code after scheduling
3: nextTick inside file
4: Promise inside file
9: Third file read complete
10: nextTick inside third file
11: Promise inside third file
5: Second file read complete
6: nextTick inside second file
7: Promise inside second file
```

---

## ðŸ”‘ KEY OBSERVATIONS

1. **Every time a file callback finishes** â†’ fast cleanup runs
2. **Multiple file callbacks can be ready** â†’ they run one at a time, with fast cleanup between each
3. **New I/O scheduled inside callbacks** â†’ goes back to Poll phase later
4. **The pattern:**
    
    ```
    Poll callback â†’ fast cleanup â†’ Poll callback â†’ fast cleanup â†’ Poll callback â†’ fast cleanup
    ```
    

---

## ðŸ§ª EVEN MORE COMPLEX: Mix with setTimeout

```js
fs.readFile('data.txt', () => {
  console.log('File done');
  
  setTimeout(() => console.log('Timer inside file'), 0);
  setImmediate(() => console.log('Immediate inside file'));
  process.nextTick(() => console.log('Tick inside file'));
  Promise.resolve().then(() => console.log('Promise inside file'));
});
```

**After file callback finishes:**

1. **Fast cleanup:** `Tick inside file` â†’ `Promise inside file`
2. **Poll phase ends**
3. **Check phase:** `Immediate inside file`
4. **Next loop - Timers phase:** `Timer inside file`

---
